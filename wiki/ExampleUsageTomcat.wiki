#labels Featured,static-dll-boostrapper
#Using libsndfile in a webapp

== Introduction ==
The following example shows how to use a libsndfile java wrapper (generated by SWIG) that references DLLs within a web container like Tomcat.


== Starting Point ==
What do I need to get started?

 # libsndfile-1.dll
  * libsndfile DLL included within a [http://www.mega-nerd.com/libsndfile/ libsndfile installer]
 # libsndfile_wrap.dll
  * Included in [http://code.google.com/p/libsndfile-java/ libsndfile java wrapper]
 # libsndfile-wrapper-0.1.jar
  * Included in [http://code.google.com/p/libsndfile-java/ libsndfile java wrapper project]
 # dll-bootstrapper-0.1.jar
  * Included in [http://code.google.com/p/static-dll-bootstrapper static dll bootstrapper project]
 # Tomcat 7 (in this example)
 # Java 1.7 (in this example)
 

== Configuration ==
 # libsndfile-1.dll -> JAVA_HOME/bin/libsndfile-1.dll
  * *WARNING*: Ensure this DLL is not found within your webapp 
 # libsndfile_wrap.dll -> JAVA_HOME/bin/libsndfile-1.dll
  * *WARNING*: Ensure this DLL is not found within your webapp 
 # libsndfile-wrapper-0.1.jar -> TOMCAT_HOME/lib/libsndfile-wrapper-0.1.jar
  * *WARNING*: Be sure this JAR is not included in your WEBAPP or you will get an UnsatisfiedLinkError because it will be loaded in the Webapps ClassLoader
 # dll-bootstrapper-0.1.jar -> TOMCAT_HOME/lib/dll-bootstrapper-0.1.jar
  * *WARNING*: Ensure this JAR is not found within your webapp 
 # dll-bootstrapper.properties -> TOMCAT_HOME/lib/dll-bootstrapper.properties

=== Contents of dll-bootstrapper.properties ===
{{{
#default properties file
dll.0=libsndfile-1
dll.1=libsndfile_wrap
}}}


== Usage ==
Within your webapp, simply add the following line of code somewhere that is guaranteed to be loaded at least once, prior to your use of libsndfile.
{{{
  // force the JVM to find and load this class (but not instantiate it)
  Class.forName("foo.DLLBootstrapper");
}}}

That's it!


== Verification ==
An easy way to verify that this works is to instantiate a libsndfile class right after the Class.forName.

{{{
try {
   Class.forName("foo.DLLBootstrapper");
} catch (Exception e) {
   logger.error("   DLLBootstrapper not found, " + e.getMessage(), e);
}

try {
   // testing that the libraries are actually loaded
   SF_INFO sf = new SF_INFO();
   logger.debug("    tested libsndfile.SF_INFO - okay (2)");
} catch (UnsatisfiedLinkError ule) {
   logger.error("  failed to load libsndfile.SF_INFO libraries (2)", ule);
}
}}}

== Why does it work? ==
Everything required to load libsndfile exists in the TOMCAT_HOME/lib directory, which means when they are loaded by Tomcat, they are loaded into the shared/common ClassLoader, which means they are available to all webapps ([http://tomcat.apache.org/tomcat-7.0-doc/class-loader-howto.html as explained in the Tomcat documentation]).

Required DLLs exist within the JAVA_HOME/bin directory, which is necessary if you don't want to setup a java.library.path .  I forget exactly why this works, but it does.

When Class.forName is executed, the JVM will load the DLLBootstrapper class into the shared/common ClassLoader.  The DLLBootstrapper will then load all DLLs (or libraries) referenced in it's properties file, which makes them available to all webapps running in Tomcat.

Make sense?


Awesome.